<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Response Dashboard - Control Room</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #0f1419;
            color: white;
            min-height: 100vh;
            overflow: hidden;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: #1a1f2e;
            padding: 20px;
            border-right: 1px solid #2d3748;
            display: flex;
            flex-direction: column;
        }

        .responder-info {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #2d3748;
            margin-bottom: 20px;
        }

        .responder-avatar {
            width: 80px;
            height: 80px;
            background: #007bff;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #2d3748;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-critical { color: #ff4444; }
        .stat-warning { color: #ff9500; }
        .stat-success { color: #28a745; }

        .emergency-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        .emergency-card {
            background: #2d3748;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #ff4444;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .emergency-card:hover {
            transform: translateX(5px);
            background: #3a4558;
        }

        .emergency-card.assigned {
            border-left-color: #28a745;
        }

        .emergency-card.resolved {
            border-left-color: #6c757d;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-rows: auto 1fr;
        }

        .header {
            background: #1a1f2e;
            padding: 20px;
            border-bottom: 1px solid #2d3748;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-container {
            padding: 20px;
        }

        #responseMap {
            height: 100%;
            border-radius: 15px;
        }

        /* Emergency Details */
        .emergency-details {
            background: #1a1f2e;
            padding: 20px;
            border-left: 1px solid #2d3748;
            display: flex;
            flex-direction: column;
        }

        .details-content {
            flex: 1;
            overflow-y: auto;
        }

        .action-buttons {
            display: grid;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ff9500; color: white; }
        .btn-danger { background: #dc3545; color: white; }

        .btn:hover { opacity: 0.9; }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            z-index: 1000;
        }

        .connection-status.connecting {
            background: #ff9500;
        }

        .connection-status.disconnected {
            background: #dc3545;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(255, 68, 68, 0.3);
            z-index: 1000;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Emergency Priority */
        .priority-high { color: #ff4444; }
        .priority-medium { color: #ff9500; }
        .priority-low { color: #28a745; }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">üü¢ Connected</div>
    
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="responder-info">
                <div class="responder-avatar">üëÆ</div>
                <h3>Response Unit 01</h3>
                <p>John Doe - Senior Responder</p>
                <div style="color: #28a745; margin-top: 5px;">‚óè ONLINE</div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number stat-critical" id="totalEmergencies">1</div>
                    <div>Total Emergencies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-warning" id="pendingEmergencies">1</div>
                    <div>Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-success" id="assignedEmergencies">0</div>
                    <div>Assigned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="resolvedEmergencies">0</div>
                    <div>Resolved</div>
                </div>
            </div>

            <h3>üö® Active Emergencies</h3>
            <div class="emergency-list" id="emergencyList">
                <!-- Emergencies will appear here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>üö® Emergency Response Dashboard</h1>
                <div>Last updated: <span id="lastUpdated">Just now</span></div>
            </div>

            <div class="map-container">
                <div id="responseMap"></div>
            </div>
        </div>

        <!-- Emergency Details Panel -->
        <div class="emergency-details" id="emergencyDetails">
            <h3>Emergency Details</h3>
            <div class="details-content" id="detailsContent">
                <p>Select an emergency to view details</p>
            </div>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="assignToMe()">‚úÖ Assign to Me</button>
                <button class="btn btn-primary" onclick="navigateToEmergency()">üß≠ Navigate to Location</button>
                <button class="btn btn-warning" onclick="contactTourist()">üìû Contact Tourist</button>
                <button class="btn btn-danger" onclick="resolveEmergency()">‚úÖ Mark as Resolved</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Emergency data
        let emergencies = [];
        let responseMap;
        let emergencyMarkers = [];
        let selectedEmergency = null;
        let socket = null;

        // Initialize the dashboard
        function initDashboard() {
            initMap();
            initWebSocket();
            loadEmergencies();
            updateLastUpdated();
        }

        // Initialize WebSocket connection (simulated)
        function initWebSocket() {
            updateConnectionStatus('connecting', 'üü° Connecting to server...');
            
            // Simulate WebSocket connection (in real app, replace with actual WebSocket)
            setTimeout(() => {
                updateConnectionStatus('connected', 'üü¢ Connected - Receiving emergencies');
                
                // Simulate receiving an emergency from a tourist
                setTimeout(() => {
                    receiveEmergencyFromTourist({
                        id: Date.now(),
                        type: "Police Assistance",
                        location: "11.166737, 76.966926",
                        tourist_id: "Tourist_7551",
                        timestamp: new Date().toLocaleString(),
                        status: "PENDING",
                        priority: "HIGH"
                    });
                }, 1000);
            }, 1500);
            
            // Simulate receiving emergencies periodically
            setInterval(() => {
                if (Math.random() > 0.8) { // 20% chance every 10 seconds
                    simulateIncomingEmergency();
                }
            }, 10000);
        }

        // Simulate receiving an emergency from a tourist
        function receiveEmergencyFromTourist(emergency) {
            emergencies.unshift(emergency);
            updateEmergencyList();
            updateMapMarkers();
            updateStats();
            updateLastUpdated();
            showNotification(`üö® NEW EMERGENCY: ${emergency.type}`);
            
            // Auto-select the new emergency
            selectEmergency(emergency.id);
        }

        // Simulate an incoming emergency (for demo purposes)
        function simulateIncomingEmergency() {
            const emergencyTypes = [
                "Voice SOS Command", 
                "Medical Assistance", 
                "Police Assistance", 
                "Online Emergency"
            ];
            
            const priorities = ["LOW", "MEDIUM", "HIGH", "CRITICAL"];
            
            const newEmergency = {
                id: Date.now(),
                type: emergencyTypes[Math.floor(Math.random() * emergencyTypes.length)],
                location: `${(11.166 + Math.random() * 0.02).toFixed(6)}, ${(76.966 + Math.random() * 0.02).toFixed(6)}`,
                tourist_id: `Tourist_${Math.floor(1000 + Math.random() * 9000)}`,
                timestamp: new Date().toLocaleString(),
                status: "PENDING",
                priority: priorities[Math.floor(Math.random() * priorities.length)]
            };

            receiveEmergencyFromTourist(newEmergency);
        }

        // Update connection status
        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = message;
            statusElement.className = 'connection-status ' + status;
        }

        // Initialize map
        function initMap() {
            responseMap = L.map('responseMap').setView([11.166737, 76.966926], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(responseMap);
        }

        // Load emergencies (initial data)
        function loadEmergencies() {
            // Start with an empty list - emergencies will come via WebSocket
            emergencies = [];
            updateEmergencyList();
            updateMapMarkers();
            updateStats();
        }

        // Update emergency list in sidebar
        function updateEmergencyList() {
            const emergencyList = document.getElementById('emergencyList');
            
            if (emergencies.length === 0) {
                emergencyList.innerHTML = '<div class="emergency-card">No active emergencies</div>';
                return;
            }

            emergencyList.innerHTML = emergencies.map(emergency => `
                <div class="emergency-card ${emergency.status.toLowerCase()}" 
                     onclick="selectEmergency(${emergency.id})">
                    <strong>${emergency.type}</strong>
                    <div style="font-size: 0.9em; margin: 5px 0;">Tourist: ${emergency.tourist_id}</div>
                    <div style="font-size: 0.8em; color: #ccc;">${emergency.timestamp}</div>
                    <div style="font-size: 0.8em; color: ${getStatusColor(emergency.status)};">
                        ‚óè ${emergency.status}
                    </div>
                    ${emergency.assigned_to ? `<div style="font-size: 0.8em;">Assigned: ${emergency.assigned_to}</div>` : ''}
                </div>
            `).join('');
        }

        // Update map with emergency markers
        function updateMapMarkers() {
            // Clear existing markers
            emergencyMarkers.forEach(marker => responseMap.removeLayer(marker));
            emergencyMarkers = [];

            // Add new markers
            emergencies.forEach(emergency => {
                const [lat, lng] = emergency.location.split(',').map(coord => parseFloat(coord.trim()));
                
                const marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: getMarkerIcon(emergency),
                        iconSize: [30, 30],
                        className: 'emergency-marker'
                    })
                }).addTo(responseMap);

                marker.bindPopup(`
                    <strong>${emergency.type}</strong><br>
                    Tourist: ${emergency.tourist_id}<br>
                    Time: ${emergency.timestamp}<br>
                    Status: ${emergency.status}<br>
                    <button onclick="selectEmergency(${emergency.id})" style="margin-top: 10px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">
                        View Details
                    </button>
                `);

                emergencyMarkers.push(marker);
            });
        }

        // Get marker icon based on emergency status
        function getMarkerIcon(emergency) {
            const icons = {
                'PENDING': 'üî¥',
                'ASSIGNED': 'üü°', 
                'RESOLVED': 'üü¢'
            };
            return `<div style="font-size: 24px;">${icons[emergency.status] || 'üî¥'}</div>`;
        }

        // Get status color
        function getStatusColor(status) {
            const colors = {
                'PENDING': '#ff4444',
                'ASSIGNED': '#ff9500',
                'RESOLVED': '#28a745'
            };
            return colors[status] || '#ff4444';
        }

        // Get priority class
        function getPriorityClass(priority) {
            const classes = {
                'LOW': 'priority-low',
                'MEDIUM': 'priority-medium',
                'HIGH': 'priority-high',
                'CRITICAL': 'priority-high'
            };
            return classes[priority] || 'priority-medium';
        }

        // Update statistics
        function updateStats() {
            const total = emergencies.length;
            const pending = emergencies.filter(e => e.status === 'PENDING').length;
            const assigned = emergencies.filter(e => e.status === 'ASSIGNED').length;
            const resolved = emergencies.filter(e => e.status === 'RESOLVED').length;

            document.getElementById('totalEmergencies').textContent = total;
            document.getElementById('pendingEmergencies').textContent = pending;
            document.getElementById('assignedEmergencies').textContent = assigned;
            document.getElementById('resolvedEmergencies').textContent = resolved;
        }

        // Select emergency for details
        function selectEmergency(emergencyId) {
            selectedEmergency = emergencies.find(e => e.id === emergencyId);
            
            if (selectedEmergency) {
                document.getElementById('detailsContent').innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong>${selectedEmergency.type}</strong>
                        <div style="color: ${getStatusColor(selectedEmergency.status)}; margin: 5px 0;">
                            ‚óè ${selectedEmergency.status}
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Tourist ID:</strong> ${selectedEmergency.tourist_id}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Location:</strong> ${selectedEmergency.location}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Time:</strong> ${selectedEmergency.timestamp}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Priority:</strong> 
                        <span class="${getPriorityClass(selectedEmergency.priority)}">
                            ${selectedEmergency.priority}
                        </span>
                    </div>
                    ${selectedEmergency.assigned_to ? `
                        <div style="margin-bottom: 10px;">
                            <strong>Assigned To:</strong> ${selectedEmergency.assigned_to}
                        </div>
                    ` : ''}
                `;

                // Center map on selected emergency
                const [lat, lng] = selectedEmergency.location.split(',').map(coord => parseFloat(coord.trim()));
                responseMap.setView([lat, lng], 15);
            }
        }

        // Action functions
        function assignToMe() {
            if (selectedEmergency) {
                selectedEmergency.status = 'ASSIGNED';
                selectedEmergency.assigned_to = 'Unit_01 (You)';
                updateEmergencyList();
                updateMapMarkers();
                updateStats();
                showNotification('‚úÖ Emergency assigned to you!');
                
                // In a real app, send this update to the tourist
                // sendUpdateToTourist(selectedEmergency.id, 'ASSIGNED', 'Unit_01');
            }
        }

        function navigateToEmergency() {
            if (selectedEmergency) {
                const [lat, lng] = selectedEmergency.location.split(',').map(coord => parseFloat(coord.trim()));
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
            }
        }

        function contactTourist() {
            if (selectedEmergency) {
                showNotification('üìû Opening communication channel with tourist...');
                // Simulate calling/chatting
                setTimeout(() => {
                    alert(`Connected to ${selectedEmergency.tourist_id}. Audio channel established.`);
                }, 1000);
            }
        }

        function resolveEmergency() {
            if (selectedEmergency) {
                selectedEmergency.status = 'RESOLVED';
                updateEmergencyList();
                updateMapMarkers();
                updateStats();
                showNotification('‚úÖ Emergency marked as resolved!');
                
                // In a real app, send this update to the tourist
                // sendUpdateToTourist(selectedEmergency.id, 'RESOLVED');
            }
        }

        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Update last updated time
        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>